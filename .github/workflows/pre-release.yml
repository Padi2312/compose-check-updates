name: Pre-release ccu
on:
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.23.2'  # Use the Go version that your project requires

      - name: Run Tests
        run: |
          go test ./...


  build-and-upload:
    name: Build and upload
    runs-on: ubuntu-latest
    needs: test  # Add this line to ensure the test job runs first

    strategy:
      matrix:
        os: [linux, windows]
        goarch: [amd64]  # Add more architectures if needed

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        run: |
          version=$(grep -o 'var version = "[^"]*"' main.go | cut -d'"' -f2)
          echo "VERSION=$version" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.23.2'  # Use the Go version that your project requires

      - name: Build
        run: |
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.goarch }} go build -ldflags="-s -w" -o ${{ github.workspace }}/build/ccu-${{ matrix.os }}-${{ matrix.goarch }}${{ matrix.os == 'windows' && '.exe' || '' }} main.go
          echo "ASSET=${{ github.workspace }}/build/ccu-${{ matrix.os }}-${{ matrix.goarch }}${{ matrix.os == 'windows' && '.exe' || '' }}" >> $GITHUB_ENV

      - name: Tag commit
        run: |
          git tag ${{ env.VERSION }}
          git push origin ${{ env.VERSION }}

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.ASSET }}
          tag_name: ${{ env.VERSION }}
          prerelease: true

